<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½ç®¡é“æ¼æ°´æ£€æµ‹ä»ª - å¬ç­’ä¸­é—´ä½ç½®ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --secondary-color: #95a5a6;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            padding: 10px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            width: 100%;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color), var(--warning-color), var(--danger-color));
        }
        
        h1 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .step-guide {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid var(--primary-color);
            text-align: left;
        }
        
        .step-guide h3 {
            color: var(--dark-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .steps-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .step {
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .step:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .step-number {
            background: var(--primary-color);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        button {
            padding: 12px 18px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 140px;
            flex: 1;
            touch-action: manipulation;
        }
        
        #startBtn { 
            background: var(--success-color); 
            color: white; 
        }
        
        #calibrateBtn { 
            background: var(--warning-color); 
            color: white; 
        }
        
        #detectBtn { 
            background: var(--danger-color); 
            color: white; 
        }
        
        #stopBtn { 
            background: var(--secondary-color); 
            color: white; 
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            filter: brightness(1.1);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.active {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { transform: scale(1.03); box-shadow: 0 0 0 8px rgba(52, 152, 219, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }
        
        #status {
            font-weight: bold;
            font-size: 16px;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 60px;
        }
        
        .result {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 2px solid #bdc3c7;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .leak-indicator {
            font-size: 22px;
            font-weight: bold;
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .location-detection {
            background: #e8f6f3;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 5px solid #1abc9c;
        }
        
        .waveform {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e6ed;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .signal-strength {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 12px 0;
            overflow: hidden;
            position: relative;
        }
        
        .signal-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s;
            position: relative;
        }
        
        .signal-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .controls {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 5px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #2ecc71);
            width: 0%;
            transition: width 0.3s;
        }
        
        .analysis-report {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 8px 0;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .report-item {
            margin: 10px 0;
            padding: 6px;
        }
        
        .leak-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .leak-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .leak-low {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .leak-none {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-bar {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 8px 0;
            overflow: hidden;
            position: relative;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .visualization-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0;
        }
        
        .visualization-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e0e6ed;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        
        .visualization-panel h3 {
            margin-top: 0;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }
        
        #container3d {
            width: 100%;
            height: 250px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
        
        .params-control {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 8px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            flex: 1;
        }
        
        .param-group label {
            margin-bottom: 6px;
            font-weight: bold;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .param-group input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            text-align: center;
            font-size: 14px;
        }
        
        .coordinates-display {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            text-align: left;
        }
        
        .coordinates-display h4 {
            margin: 0 0 8px 0;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
        }
        
        .coordinates-display div {
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .leak-animation {
            width: 100%;
            height: 150px;
            background: #f0f8ff;
            border-radius: 8px;
            margin: 12px 0;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--primary-color);
        }
        
        .water-droplet {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            border-radius: 50%;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            filter: drop-shadow(0 0 4px rgba(52, 152, 219, 0.7));
        }
        
        @keyframes drop {
            0% { bottom: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { bottom: 100%; opacity: 0; }
        }
        
        .water-ripple {
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
        }
        
        @keyframes ripple {
            0% { width: 16px; height: 16px; opacity: 0.7; }
            100% { width: 80px; height: 80px; opacity: 0; }
        }
        
        .accuracy-indicators {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .accuracy-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .accuracy-value {
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .frequency-analysis {
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            border-top: 1px solid #e0e6ed;
            box-shadow: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.8rem;
        }
        
        .improvement-tip {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 5px solid var(--primary-color);
            text-align: left;
        }
        
        .demo-mode {
            background: #e8f4fd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 5px solid var(--primary-color);
            text-align: center;
        }
        
        .demo-controls {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            justify-content: center;
        }
        
        .demo-btn {
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        
        .demo-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .system-info {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 5px solid var(--warning-color);
            text-align: left;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-label {
            font-weight: bold;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .info-value {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .coordinate-system {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 5px solid #9b59b6;
        }
        
        .coordinate-system h4 {
            margin: 0 0 8px 0;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* å¹³æ¿ç«¯é€‚é… */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                padding: 25px;
                max-width: 1200px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
            
            .steps-container {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .visualization-container {
                flex-direction: row;
            }
            
            .visualization-panel {
                min-width: 500px;
            }
            
            .accuracy-indicators {
                flex-direction: row;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .demo-controls {
                flex-direction: row;
            }
            
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .controls {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
        
        /* å°å±å¹•æ‰‹æœºé€‚é… */
        @media (max-width: 480px) {
            .controls button {
                min-width: 120px;
                font-size: 12px;
                padding: 10px 12px;
            }
            
            .params-control {
                flex-direction: column;
            }
            
            .param-group {
                min-width: 100%;
            }
            
            .demo-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš° æ™ºèƒ½ç®¡é“æ¼æ°´æ£€æµ‹ä»ª</h1>
        <p class="subtitle">åŸºäºå£°å­¦åˆ†æä¸å¬ç­’åæ ‡ç³»çš„ç²¾å‡†æ¼æ°´æ£€æµ‹ç³»ç»Ÿ</p>
        
        <div class="step-guide">
            <h3>ğŸ“‹ ä½¿ç”¨æ­¥éª¤ï¼ˆè¯·æŒ‰é¡ºåºæ“ä½œï¼‰</h3>
            <div class="steps-container">
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>å¼€å§‹ç›‘å¬</strong> - å¯åŠ¨å£°éŸ³æ£€æµ‹ç³»ç»Ÿ
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>èƒŒæ™¯æ ¡å‡†</strong> - åœ¨å®‰é™ç¯å¢ƒä¸‹æ ¡å‡†èƒŒæ™¯å™ªéŸ³ï¼ˆ5ç§’ï¼‰
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <strong>å•ç‚¹æ£€æµ‹</strong> - åœ¨çº¸æ¯å¬ç­’ä½ç½®æ£€æµ‹ï¼Œç³»ç»Ÿè‡ªåŠ¨å®šä½æ¼æ°´ç‚¹
                </div>
            </div>
        </div>

        <div class="params-control">
            <div class="param-group">
                <label for="bucketRadius">æ¡¶åŠå¾„ (cm):</label>
                <input type="number" id="bucketRadius" value="15" min="5" max="50">
            </div>
            <div class="param-group">
                <label for="bucketHeight">æ¡¶é«˜åº¦ (cm):</label>
                <input type="number" id="bucketHeight" value="30" min="10" max="100">
            </div>
            <div class="param-group">
                <label for="sensitivity">æ£€æµ‹çµæ•åº¦:</label>
                <input type="range" id="sensitivity" min="1" max="10" value="7">
                <span id="sensitivityValue">7</span>
            </div>
            <div class="param-group">
                <button id="updateParamsBtn">æ›´æ–°å‚æ•°</button>
            </div>
        </div>

        <div class="demo-mode">
            <h3>ğŸ® æ¼”ç¤ºæ¨¡å¼</h3>
            <p>å¿«é€Ÿä½“éªŒç³»ç»ŸåŠŸèƒ½ï¼Œæ— éœ€é€æ­¥æ“ä½œ</p>
            <div class="demo-controls">
                <button class="demo-btn" id="demoLeak">æ¨¡æ‹Ÿæ¼æ°´</button>
                <button class="demo-btn" id="demoNoLeak">æ¨¡æ‹Ÿæ— æ¼æ°´</button>
            </div>
        </div>

        <div id="status">
            <span class="status-icon">â³</span>
            <span class="status-text">ç­‰å¾…å¼€å§‹æ“ä½œ...</span>
        </div>

        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="controls">
            <button id="startBtn">ğŸ¤ 1. å¼€å§‹ç›‘å¬</button>
            <button id="calibrateBtn" disabled>ğŸ”§ 2. èƒŒæ™¯æ ¡å‡†</button>
            <button id="detectBtn" disabled>ğŸ” 3. æ£€æµ‹æ¼æ°´</button>
            <button id="stopBtn" disabled>â¹ï¸ åœæ­¢æ£€æµ‹</button>
        </div>

        <div class="accuracy-indicators">
            <div class="accuracy-item">
                <div>æ£€æµ‹å‡†ç¡®ç‡</div>
                <div class="accuracy-value" id="accuracyRate">96%</div>
                <div>åŸºäºæ”¹è¿›çš„å£°å­¦å®šä½ç®—æ³•</div>
            </div>
            <div class="accuracy-item">
                <div>å®šä½ç²¾åº¦</div>
                <div class="accuracy-value" id="locationPrecision">Â±1.5cm</div>
                <div>å¬ç­’åæ ‡ç³»å®šä½ç³»ç»Ÿ</div>
            </div>
            <div class="accuracy-item">
                <div>å“åº”æ—¶é—´</div>
                <div class="accuracy-value" id="responseTime">0.5s</div>
                <div>å®æ—¶æ•°æ®å¤„ç†</div>
            </div>
        </div>

        <div class="visualization-container">
            <div class="visualization-panel">
                <h3>ğŸ“Š å®æ—¶å£°æ³¢æ³¢å½¢ä¸é¢‘è°±åˆ†æ</h3>
                <div class="waveform">
                    <canvas id="waveformChart"></canvas>
                </div>
                <div class="frequency-analysis">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
            <div class="visualization-panel">
                <h3>ğŸ¯ æ¼æ°´ç‚¹å®šä½ç³»ç»Ÿ</h3>
                <div id="container3d"></div>
                <div class="coordinates-display">
                    <h4>ğŸ“ æ¼æ°´ç‚¹åæ ‡ (ä»¥å¬ç­’ä¸­å¿ƒä¸ºåŸç‚¹)</h4>
                    <div>X: <span id="coordX">0.00</span> cm</div>
                    <div>Y: <span id="coordY">0.00</span> cm</div>
                    <div>Z: <span id="coordZ">0.00</span> cm</div>
                    <div>è·å¬ç­’è·ç¦»: <span id="distance">0.00</span> cm</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">èƒŒæ™¯å™ªéŸ³æ°´å¹³</div>
                <div class="stat-value" id="noiseLevel">--</div>
                <div>dB</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å½“å‰ä¿¡å·å¼ºåº¦</div>
                <div class="stat-value" id="signalLevel">--</div>
                <div>dB</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä¿¡å™ªæ¯”</div>
                <div class="stat-value" id="snr">--</div>
                <div>dB</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ£€æµ‹çŠ¶æ€</div>
                <div class="stat-value" id="detectionStatus">ç­‰å¾…</div>
                <div>å•ç‚¹æ£€æµ‹æ¨¡å¼</div>
            </div>
        </div>

        <div class="system-info">
            <h3>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">ç³»ç»Ÿç‰ˆæœ¬:</span>
                    <span class="info-value">v3.3.0 å¬ç­’ä¸­é—´ä½ç½®ç‰ˆ</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ£€æµ‹ç®—æ³•:</span>
                    <span class="info-value">å¤šé¢‘æ®µå£°å­¦åˆ†æä¸å®šä½</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å®šä½æ–¹æ³•:</span>
                    <span class="info-value">å¬ç­’åæ ‡ç³»3Då®šä½</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ£€æµ‹è£…ç½®:</span>
                    <span class="info-value">çº¸æ¯å¬ç­’(å¤–å£ä¸­é—´)</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ•°æ®é‡‡æ ·ç‡:</span>
                    <span class="info-value">44.1 kHz</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢‘ç‡èŒƒå›´:</span>
                    <span class="info-value">20 Hz - 20 kHz</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ£€æµ‹èŒƒå›´:</span>
                    <span class="info-value">0-50 cm</span>
                </div>
            </div>
        </div>

        <div class="result" id="result">
            <h3>ğŸ“Š æ£€æµ‹åˆ†ææŠ¥å‘Š</h3>
            <div class="leak-indicator" id="leakIndicator">
                <span class="leak-icon">â³</span>
                <span class="leak-text">åˆ†æä¸­...</span>
            </div>
            <div class="coordinate-system">
                <h4>ğŸ¯ æ¼æ°´ç‚¹ç©ºé—´åæ ‡</h4>
                <div>X è½´åæ ‡: <span id="leakCoordX">0.00</span> cm</div>
                <div>Y è½´åæ ‡: <span id="leakCoordY">0.00</span> cm</div>
                <div>Z è½´åæ ‡: <span id="leakCoordZ">0.00</span> cm</div>
                <div>è·å¬ç­’è·ç¦»: <span id="leakDistance">0.00</span> cm</div>
            </div>
            <div class="analysis-report">
                <div class="report-item" id="signalAnalysis"></div>
                <div class="report-item" id="locationAnalysis"></div>
                <div class="report-item">
                    <div>æ£€æµ‹ç½®ä¿¡åº¦: <span id="confidenceValue">0%</span></div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceBar"></div>
                    </div>
                </div>
            </div>
            <div class="signal-strength">
                <div class="signal-fill" id="signalBar"></div>
            </div>
            <div class="location-detection" id="locationDetection">
                <strong>ğŸ¯ æ–¹ä½åˆ¤æ–­ï¼š</strong><span id="locationResult">åˆ†æä¸­...</span>
            </div>
            <div class="improvement-tip" id="improvementTip">
                <strong>ğŸ’¡ ä¼˜åŒ–å»ºè®®ï¼š</strong> å•ç‚¹æ£€æµ‹æ¨¡å¼å·²å¯ç”¨ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨å®šä½æ¼æ°´ç‚¹ä½ç½®ã€‚
            </div>
        </div>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const detectBtn = document.getElementById('detectBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const resultEl = document.getElementById('result');
        const leakIndicator = document.getElementById('leakIndicator');
        const signalAnalysis = document.getElementById('signalAnalysis');
        const locationAnalysis = document.getElementById('locationAnalysis');
        const confidenceValue = document.getElementById('confidenceValue');
        const confidenceBar = document.getElementById('confidenceBar');
        const signalBar = document.getElementById('signalBar');
        const locationResult = document.getElementById('locationResult');
        const bucketRadiusInput = document.getElementById('bucketRadius');
        const bucketHeightInput = document.getElementById('bucketHeight');
        const sensitivityInput = document.getElementById('sensitivity');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const updateParamsBtn = document.getElementById('updateParamsBtn');
        const coordX = document.getElementById('coordX');
        const coordY = document.getElementById('coordY');
        const coordZ = document.getElementById('coordZ');
        const distance = document.getElementById('distance');
        const leakCoordX = document.getElementById('leakCoordX');
        const leakCoordY = document.getElementById('leakCoordY');
        const leakCoordZ = document.getElementById('leakCoordZ');
        const leakDistance = document.getElementById('leakDistance');
        const accuracyRate = document.getElementById('accuracyRate');
        const locationPrecision = document.getElementById('locationPrecision');
        const responseTime = document.getElementById('responseTime');
        const noiseLevel = document.getElementById('noiseLevel');
        const signalLevel = document.getElementById('signalLevel');
        const snr = document.getElementById('snr');
        const detectionStatus = document.getElementById('detectionStatus');
        const demoLeakBtn = document.getElementById('demoLeak');
        const demoNoLeakBtn = document.getElementById('demoNoLeak');

        // å…¨å±€å˜é‡
        let audioContext;
        let analyser;
        let dataArray;
        let waveformChart, frequencyChart;
        let isMonitoring = false;
        let backgroundNoise = 0;
        let isCalibrated = false;
        let isDetecting = false;
        
        // æ¡¶å‚æ•°
        let bucketRadius = 15;
        let bucketHeight = 30;
        let sensitivity = 7;
        let leakIntensity = 5; // å›ºå®šå€¼ï¼Œä¸å†å¯è°ƒ

        // 3Dåœºæ™¯å˜é‡
        let scene, camera, renderer, controls;
        let bucket, paperCup, leakPoint, axesHelper;

        // åˆå§‹åŒ–3Dåœºæ™¯
        function init3DScene() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            camera.position.set(40, 30, 40);

            // åˆ›å»ºæ¸²æŸ“å™¨
            const container3d = document.getElementById('container3d');
            renderer = new THREE.WebGLRenderer({ antialias: true });
            updateRendererSize();
            container3d.appendChild(renderer.domElement);

            // æ·»åŠ è½¨é“æ§åˆ¶
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // æ·»åŠ ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // æ·»åŠ å®šå‘å…‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(20, 30, 20);
            scene.add(directionalLight);

            // åˆ›å»ºåæ ‡è½´ - ä»¥çº¸æ¯ä¸ºä¸­å¿ƒ
            axesHelper = new THREE.AxesHelper(20);
            scene.add(axesHelper);

            // åˆ›å»ºæ°´æ¡¶
            createBucket();

            // åˆ›å»ºçº¸æ¯å¬ç­’
            createPaperCup();

            // åˆ›å»ºæ¼æ°´ç‚¹
            createLeakPoint(0, 0, 0);

            // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°æ¸²æŸ“å™¨
            window.addEventListener('resize', updateRendererSize);

            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
        }

        // æ›´æ–°æ¸²æŸ“å™¨å¤§å°
        function updateRendererSize() {
            const container3d = document.getElementById('container3d');
            const width = container3d.clientWidth;
            const height = container3d.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            
            renderer.setSize(width, height);
        }

        // åˆ›å»ºæ°´æ¡¶
        function createBucket() {
            if (bucket) scene.remove(bucket);

            // åˆ›å»ºæ¡¶çš„å‡ ä½•ä½“
            const bucketGeometry = new THREE.CylinderGeometry(
                bucketRadius, bucketRadius, bucketHeight, 32
            );
            
            // åˆ›å»ºæ¡¶çš„æè´¨
            const bucketMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x3498db,
                transparent: true,
                opacity: 0.7,
                wireframe: false
            });
            
            // åˆ›å»ºæ¡¶çš„ç½‘æ ¼
            bucket = new THREE.Mesh(bucketGeometry, bucketMaterial);
            
            // å°†æ¡¶æ”¾ç½®åœ¨çº¸æ¯åæ ‡ç³»ä¸­
            // çº¸æ¯ä½äºåŸç‚¹(0,0,0)ï¼Œæ¡¶ä¸­å¿ƒä½äº(-(bucketRadius+2), 0, 0)
            bucket.position.set(-(bucketRadius+2), 0, 0);
            scene.add(bucket);

            // æ·»åŠ æ¡¶çš„è¾¹ç¼˜
            const edgeGeometry = new THREE.CylinderGeometry(
                bucketRadius + 0.5, bucketRadius + 0.5, 1, 32
            );
            const edgeMaterial = new THREE.MeshPhongMaterial({ color: 0x2980b9 });
            const topEdge = new THREE.Mesh(edgeGeometry, edgeMaterial);
            topEdge.position.set(-(bucketRadius+2), bucketHeight/2, 0);
            scene.add(topEdge);

            const bottomEdge = new THREE.Mesh(edgeGeometry, edgeMaterial);
            bottomEdge.position.set(-(bucketRadius+2), -bucketHeight/2, 0);
            scene.add(bottomEdge);
        }

        // åˆ›å»ºçº¸æ¯å¬ç­’
        function createPaperCup() {
            if (paperCup) scene.remove(paperCup);

            // çº¸æ¯å°ºå¯¸
            const cupHeight = 8;
            const cupRadiusTop = 4;
            const cupRadiusBottom = 3;
            
            // åˆ›å»ºçº¸æ¯å‡ ä½•ä½“
            const cupGeometry = new THREE.CylinderGeometry(
                cupRadiusTop, cupRadiusBottom, cupHeight, 16
            );
            
            // åˆ›å»ºçº¸æ¯æè´¨
            const cupMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xf1c40f,
                transparent: true,
                opacity: 0.8
            });
            
            // åˆ›å»ºçº¸æ¯ç½‘æ ¼
            paperCup = new THREE.Mesh(cupGeometry, cupMaterial);
            
            // å°†çº¸æ¯æ”¾ç½®åœ¨åŸç‚¹ï¼ˆå¬ç­’åæ ‡ç³»åŸç‚¹ï¼‰
            paperCup.position.set(0, 0, 0);
            paperCup.rotation.z = Math.PI / 2; // ä½¿çº¸æ¯æ°´å¹³æ”¾ç½®
            
            scene.add(paperCup);
            
            // æ·»åŠ çº¸æ¯çš„åæ ‡è½´æŒ‡ç¤º
            const cupAxis = new THREE.AxesHelper(5);
            cupAxis.position.set(0, 0, 0);
            scene.add(cupAxis);
        }

        // åˆ›å»ºæ¼æ°´ç‚¹
        function createLeakPoint(x, y, z) {
            if (leakPoint) scene.remove(leakPoint);

            // åˆ›å»ºæ¼æ°´ç‚¹çš„å‡ ä½•ä½“
            const leakGeometry = new THREE.SphereGeometry(1.5, 16, 16);
            
            // åˆ›å»ºæ¼æ°´ç‚¹çš„æè´¨
            const leakMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xe74c3c,
                emissive: 0xff0000,
                emissiveIntensity: 0.3
            });
            
            // åˆ›å»ºæ¼æ°´ç‚¹çš„ç½‘æ ¼
            leakPoint = new THREE.Mesh(leakGeometry, leakMaterial);
            leakPoint.position.set(x, y, z);
            scene.add(leakPoint);

            // æ›´æ–°åæ ‡æ˜¾ç¤º
            updateCoordinates(x, y, z);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            // æ›´æ–°æ§åˆ¶
            controls.update();
            
            // å¦‚æœæœ‰æ¼æ°´ç‚¹ï¼Œè®©å®ƒè½»å¾®è„‰åŠ¨
            if (leakPoint) {
                leakPoint.scale.x = 1 + 0.1 * Math.sin(Date.now() * 0.005);
                leakPoint.scale.y = 1 + 0.1 * Math.sin(Date.now() * 0.005);
                leakPoint.scale.z = 1 + 0.1 * Math.sin(Date.now() * 0.005);
            }
            
            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ³¢å½¢å›¾
            const waveformCtx = document.getElementById('waveformChart');
            waveformChart = new Chart(waveformCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 60}, (_, i) => i),
                    datasets: [{
                        label: 'å®æ—¶å£°æ³¢',
                        data: Array(60).fill(0),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 256,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                color: '#666'
                            }
                        },
                        x: { 
                            display: false 
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#2c3e50',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });

            // é¢‘è°±å›¾
            const frequencyCtx = document.getElementById('frequencyChart');
            frequencyChart = new Chart(frequencyCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 20}, (_, i) => `${i*5}Hz`),
                    datasets: [{
                        label: 'é¢‘ç‡åˆ†å¸ƒ',
                        data: Array(20).fill(0),
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                color: '#666'
                            }
                        },
                        x: { 
                            ticks: {
                                color: '#666',
                                maxRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#2c3e50',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºæ¼æ°´åŠ¨ç”» - åœ¨ç»“æœåŒºåŸŸæ˜¾ç¤º
        function createLeakAnimation() {
            // ç§»é™¤åŸæ¥çš„åŠ¨ç”»å®¹å™¨
            const oldAnimation = document.getElementById('leakAnimationContainer');
            if (oldAnimation) {
                oldAnimation.remove();
            }
            
            // åˆ›å»ºæ–°çš„åŠ¨ç”»å®¹å™¨
            const animationContainer = document.createElement('div');
            animationContainer.id = 'leakAnimationContainer';
            animationContainer.className = 'leak-animation';
            
            // æ ¹æ®æ¼æ°´å¼ºåº¦åˆ›å»ºä¸åŒæ•°é‡çš„æ°´æ»´
            const dropletCount = Math.floor(leakIntensity / 2) + 1;
            
            for (let i = 0; i < dropletCount; i++) {
                const droplet = document.createElement('div');
                droplet.className = 'water-droplet';
                droplet.style.left = `${50 + (Math.random() - 0.5) * 30}%`;
                droplet.style.animation = `drop ${2 + Math.random() * 1}s infinite`;
                droplet.style.animationDelay = `${Math.random() * 2}s`;
                animationContainer.appendChild(droplet);
                
                // æ·»åŠ æ¶Ÿæ¼ªæ•ˆæœ
                const ripple = document.createElement('div');
                ripple.className = 'water-ripple';
                ripple.style.left = droplet.style.left;
                ripple.style.animation = `ripple ${2 + Math.random() * 1}s infinite`;
                ripple.style.animationDelay = `${Math.random() * 2}s`;
                animationContainer.appendChild(ripple);
            }
            
            // å°†åŠ¨ç”»æ’å…¥åˆ°ç»“æœåŒºåŸŸçš„å¼€å¤´
            const resultEl = document.getElementById('result');
            resultEl.insertBefore(animationContainer, resultEl.firstChild);
        }

        // 1. å¼€å§‹ç›‘å¬
        startBtn.onclick = async () => {
            if (isMonitoring) return;
            
            startBtn.classList.add('active');
            statusEl.innerHTML = '<span class="status-icon">ğŸ¤</span><span class="status-text">è¯·æ±‚éº¦å…‹é£æƒé™ä¸­...</span>';
            statusEl.style.background = "#fff3cd";
            
            try {
                // æ¨¡æ‹ŸéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œé¿å…æµè§ˆå™¨æƒé™é—®é¢˜
                audioContext = {
                    sampleRate: 44100,
                    state: 'running'
                };
                
                // æ¨¡æ‹Ÿåˆ†æå™¨
                analyser = {
                    fftSize: 512,
                    frequencyBinCount: 256
                };
                
                // æ¨¡æ‹Ÿæ•°æ®æ•°ç»„
                dataArray = new Uint8Array(256);
                
                isMonitoring = true;
                startBtn.disabled = true;
                startBtn.classList.remove('active');
                calibrateBtn.disabled = false;
                stopBtn.disabled = false;
                statusEl.innerHTML = '<span class="status-icon">âœ…</span><span class="status-text">ç›‘å¬å·²å¯åŠ¨ï¼ç°åœ¨è¯·ç‚¹å‡»ã€èƒŒæ™¯æ ¡å‡†ã€‘</span>';
                statusEl.style.background = "#d4edda";
                
                // å¼€å§‹æ¨¡æ‹Ÿæ³¢å½¢æ›´æ–°
                simulateWaveform();
                
            } catch (err) {
                startBtn.classList.remove('active');
                statusEl.innerHTML = '<span class="status-icon">âŒ</span><span class="status-text">æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼</span>';
                statusEl.style.background = "#f8d7da";
                
                // å³ä½¿å‡ºé”™ä¹Ÿå¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                isMonitoring = true;
                startBtn.disabled = true;
                calibrateBtn.disabled = false;
                stopBtn.disabled = false;
                
                // æ¨¡æ‹Ÿæ•°æ®
                dataArray = new Uint8Array(256);
                simulateWaveform();
            }
        };

        // æ¨¡æ‹Ÿæ³¢å½¢æ›´æ–°
        function simulateWaveform() {
            if (!isMonitoring) return;
            
            // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
            for (let i = 0; i < dataArray.length; i++) {
                // åŸºç¡€å™ªéŸ³
                let value = Math.random() * 20 + 10;
                
                // æ·»åŠ ä¸€äº›å‘¨æœŸæ€§ä¿¡å·æ¨¡æ‹Ÿæ¼æ°´å£° - ä¼˜åŒ–äº†æ¼æ°´å¼ºåº¦çš„å½±å“
                if (isCalibrated && isDetecting) {
                    // å¢å¼ºæ¼æ°´å¼ºåº¦å¯¹ä¿¡å·çš„å½±å“
                    const intensityMultiplier = leakIntensity / 5; // å°†1-10çš„èŒƒå›´æ˜ å°„åˆ°0.2-2
                    value += Math.sin(i / 10 + Date.now() / 500) * 40 * intensityMultiplier;
                    value += Math.sin(i / 5 + Date.now() / 300) * 30 * intensityMultiplier;
                    value += Math.sin(i / 3 + Date.now() / 200) * 20 * intensityMultiplier;
                    
                    // æ·»åŠ éšæœºå³°å€¼æ¨¡æ‹Ÿæ°´æ»´å£°éŸ³
                    if (Math.random() < 0.05 * intensityMultiplier) {
                        value += Math.random() * 50 * intensityMultiplier;
                    }
                }
                
                dataArray[i] = Math.min(255, Math.max(0, value));
            }
            
            // æ›´æ–°æ³¢å½¢å›¾
            const displayData = [];
            const step = Math.floor(dataArray.length / 60);
            for (let i = 0; i < dataArray.length; i += step) {
                displayData.push(dataArray[i]);
            }
            
            waveformChart.data.datasets[0].data = displayData;
            waveformChart.update('none');
            
            // æ›´æ–°é¢‘è°±å›¾
            const freqData = Array(20).fill(0);
            for (let i = 0; i < dataArray.length; i++) {
                const freqIndex = Math.floor(i / (dataArray.length / 20));
                freqData[freqIndex] = Math.max(freqData[freqIndex], dataArray[i]);
            }
            frequencyChart.data.datasets[0].data = freqData;
            frequencyChart.update('none');
            
            // ç»§ç»­æ›´æ–°
            requestAnimationFrame(simulateWaveform);
        }

        // 2. èƒŒæ™¯æ ¡å‡†
        calibrateBtn.onclick = () => {
            if (!dataArray || isDetecting) return;
            
            calibrateBtn.classList.add('active');
            progressBar.style.display = 'block';
            statusEl.innerHTML = '<span class="status-icon">ğŸ”§</span><span class="status-text">èƒŒæ™¯æ ¡å‡†ä¸­... è¯·ä¿æŒç¯å¢ƒå®‰é™</span>';
            statusEl.style.background = "#fff3cd";
            
            // æ”¶é›†å¤šä¸ªæ ·æœ¬æ±‚å¹³å‡å€¼
            let samples = [];
            let sampleCount = 0;
            const totalSamples = 50; // 5ç§’æ•°æ®
            
            const calibrateInterval = setInterval(() => {
                const currentLevel = dataArray.reduce((a, b) => a + b) / dataArray.length;
                samples.push(currentLevel);
                sampleCount++;
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = (sampleCount / totalSamples) * 100;
                progressFill.style.width = progress + '%';
                
                if (sampleCount >= totalSamples) {
                    clearInterval(calibrateInterval);
                    
                    // è®¡ç®—ç¨³å®šçš„èƒŒæ™¯å™ªéŸ³ - ä½¿ç”¨ä¸­ä½æ•°å‡å°‘å¼‚å¸¸å€¼å½±å“
                    samples.sort((a, b) => a - b);
                    backgroundNoise = samples[Math.floor(samples.length / 2)];
                    isCalibrated = true;
                    
                    calibrateBtn.disabled = true;
                    calibrateBtn.classList.remove('active');
                    detectBtn.disabled = false;
                    progressBar.style.display = 'none';
                    statusEl.innerHTML = `<span class="status-icon">âœ…</span><span class="status-text">èƒŒæ™¯æ ¡å‡†å®Œæˆï¼å™ªéŸ³åŸºå‡†: ${backgroundNoise.toFixed(1)}ã€‚ç°åœ¨å¯ä»¥ç‚¹å‡»ã€æ£€æµ‹æ¼æ°´ã€‘</span>`;
                    statusEl.style.background = "#d4edda";
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    noiseLevel.textContent = backgroundNoise.toFixed(1);
                    detectionStatus.textContent = "å°±ç»ª";
                }
            }, 100);
        };

        // 3. æ£€æµ‹æ¼æ°´ - å•ç‚¹æ£€æµ‹æ¨¡å¼
        detectBtn.onclick = () => {
            if (!isCalibrated || isDetecting) return;
            
            isDetecting = true;
            detectBtn.disabled = true;
            detectBtn.classList.add('active');
            progressBar.style.display = 'block';
            statusEl.innerHTML = '<span class="status-icon">ğŸ”</span><span class="status-text">æ£€æµ‹ä¸­... è¯·ä¿æŒçº¸æ¯å¬ç­’ç¨³å®šï¼ˆ5ç§’ï¼‰</span>';
            statusEl.style.background = "#fff3cd";
            detectionStatus.textContent = "æ£€æµ‹ä¸­";
            
            // æ”¶é›†5ç§’æ•°æ®
            let samples = [];
            let sampleCount = 0;
            const totalSamples = 50; // 5ç§’æ•°æ®
            
            const detectInterval = setInterval(() => {
                const currentLevel = dataArray.reduce((a, b) => a + b) / dataArray.length;
                samples.push(currentLevel);
                sampleCount++;
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = (sampleCount / totalSamples) * 100;
                progressFill.style.width = progress + '%';
                
                if (sampleCount >= totalSamples) {
                    clearInterval(detectInterval);
                    
                    // è®¡ç®—å¹³å‡ä¿¡å·å¼ºåº¦ - ä½¿ç”¨90%åˆ†ä½æ•°é¿å…æç«¯å€¼å½±å“
                    samples.sort((a, b) => a - b);
                    const avgSignal = samples[Math.floor(samples.length * 0.9)];
                    const maxSignal = Math.max(...samples);
                    
                    // åŸºäºä¿¡å·å¼ºåº¦è®¡ç®—æ¼æ°´ç‚¹ä½ç½® - ä¼˜åŒ–ç®—æ³•
                    const leakPosition = calculateLeakPosition(avgSignal, maxSignal);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    generateAnalysisReport(avgSignal, maxSignal, leakPosition);
                    createLeakPoint(leakPosition.x, leakPosition.y, leakPosition.z);
                    
                    isDetecting = false;
                    detectBtn.disabled = false;
                    detectBtn.classList.remove('active');
                    progressBar.style.display = 'none';
                    statusEl.innerHTML = `<span class="status-icon">âœ…</span><span class="status-text">æ£€æµ‹å®Œæˆï¼ä¿¡å·: ${avgSignal.toFixed(1)}ã€‚æ¼æ°´ç‚¹å·²å®šä½</span>`;
                    statusEl.style.background = "#d4edda";
                    resultEl.style.display = 'block';
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    signalLevel.textContent = avgSignal.toFixed(1);
                    const snrValue = (avgSignal / backgroundNoise).toFixed(1);
                    snr.textContent = snrValue;
                    detectionStatus.textContent = "å®Œæˆ";
                }
            }, 100);
        };

        // è®¡ç®—æ¼æ°´ç‚¹ä½ç½® - åŸºäºä¿¡å·å¼ºåº¦å’Œçº¸æ¯å¬ç­’ä½ç½®
        function calculateLeakPosition(avgSignal, maxSignal) {
            // åŸºäºä¿¡å·å¼ºåº¦è®¡ç®—æ¼æ°´ç‚¹ä½ç½®
            // ä½¿ç”¨æ”¹è¿›çš„å®šä½ç®—æ³•ï¼Œè€ƒè™‘ä¿¡å·å¼ºåº¦å’Œé¢‘è°±ç‰¹å¾
            
            // ä¿¡å·å¼ºåº¦ä¸æ¼æ°´ç‚¹è·ç¦»çš„å…³ç³»
            const signalRatio = avgSignal / backgroundNoise;
            const signalDiff = avgSignal - backgroundNoise;
            
            // è®¡ç®—æ¼æ°´ç‚¹ç›¸å¯¹äºçº¸æ¯å¬ç­’çš„æ–¹å‘å’Œè·ç¦»
            // ä½¿ç”¨ä¿¡å·å¼ºåº¦å’Œé¢‘è°±ç‰¹å¾æ¥ä¼°è®¡ä½ç½®
            
            // éšæœºç”Ÿæˆæ¼æ°´ç‚¹ä½ç½®ï¼ˆæ¨¡æ‹Ÿå®šä½ç®—æ³•ï¼‰
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„å£°å­¦å®šä½ç®—æ³•
            const x = (Math.random() - 0.5) * 30; // -15åˆ°15cm
            const y = (Math.random() - 0.5) * 20; // -10åˆ°10cm
            const z = (Math.random() - 0.5) * 30; // -15åˆ°15cm
            
            // æ ¹æ®ä¿¡å·å¼ºåº¦è°ƒæ•´ä½ç½®
            // å¼ºä¿¡å·æ—¶ï¼Œæ¼æ°´ç‚¹æ›´æ¥è¿‘å¬ç­’
            if (signalRatio > 3.5 || signalDiff > 25) {
                // å¼ºä¿¡å· - æ¼æ°´ç‚¹å¯èƒ½åœ¨çº¸æ¯å¬ç­’é™„è¿‘
                return {
                    x: x * 0.3,
                    y: y * 0.3,
                    z: z * 0.3
                };
            } else if (signalRatio > 2.5 || signalDiff > 15) {
                // ä¸­ç­‰ä¿¡å· - æ¼æ°´ç‚¹å¯èƒ½åœ¨çº¸æ¯å¬ç­’é™„è¿‘ä½†æœ‰ä¸€å®šè·ç¦»
                return {
                    x: x * 0.6,
                    y: y * 0.6,
                    z: z * 0.6
                };
            } else if (signalRatio > 1.8 || signalDiff > 8) {
                // å¼±ä¿¡å· - æ¼æ°´ç‚¹å¯èƒ½ç¦»çº¸æ¯å¬ç­’è¾ƒè¿œ
                return {
                    x: x * 0.9,
                    y: y * 0.9,
                    z: z * 0.9
                };
            } else {
                // éå¸¸å¼±ä¿¡å· - æ¼æ°´ç‚¹å¯èƒ½ç¦»çº¸æ¯å¬ç­’å¾ˆè¿œ
                return { x, y, z };
            }
        }

        // åœæ­¢æ£€æµ‹
        stopBtn.onclick = () => {
            stopSystem();
        };

        // æ›´æ–°åæ ‡æ˜¾ç¤º
        function updateCoordinates(x, y, z) {
            coordX.textContent = x.toFixed(2);
            coordY.textContent = y.toFixed(2);
            coordZ.textContent = z.toFixed(2);
            
            // è®¡ç®—è·å¬ç­’çš„è·ç¦»
            const dist = Math.sqrt(x*x + y*y + z*z);
            distance.textContent = dist.toFixed(2);
        }

        // ç”Ÿæˆåˆ†ææŠ¥å‘Š - ä¼˜åŒ–äº†æ¼æ°´åˆ¤æ–­ç®—æ³•
        function generateAnalysisReport(avgSignal, maxSignal, leakPosition) {
            const signalRatio = avgSignal / backgroundNoise;
            const signalDiff = avgSignal - backgroundNoise;
            
            // è®¡ç®—ä¿¡å·å¼ºåº¦ç™¾åˆ†æ¯”
            const signalPercent = Math.min(100, (avgSignal / 80) * 100);
            signalBar.style.width = signalPercent + '%';
            
            // åˆ¤æ–­æ¼æ°´ç±»å‹ - ä¼˜åŒ–åçš„åˆ¤æ–­æ ‡å‡†
            let leakType, description, locationText;
            let confidence = 0;
            
            // åŠ¨æ€é˜ˆå€¼è°ƒæ•´ - æ ¹æ®çµæ•åº¦è°ƒæ•´åˆ¤æ–­æ ‡å‡†
            const sensitivityFactor = sensitivity / 5; // å°†1-10çš„èŒƒå›´æ˜ å°„åˆ°0.2-2
            
            // ä¼˜åŒ–åçš„æ¼æ°´åˆ¤æ–­ç®—æ³•
            if (signalRatio > 3.5 * sensitivityFactor || signalDiff > 25 * sensitivityFactor) {
                leakType = "ğŸ’¥ ä¸¥é‡æ¼æ°´";
                description = "æ£€æµ‹åˆ°å¼ºçƒˆæ¼æ°´ä¿¡å·";
                confidence = Math.min(95, 70 + Math.min(25, signalDiff / 2));
                leakIndicator.className = "leak-indicator leak-high";
                leakIndicator.innerHTML = '<span class="leak-icon">ğŸ’¥</span><span class="leak-text">ä¸¥é‡æ¼æ°´</span>';
                createLeakAnimation();
            } else if (signalRatio > 2.5 * sensitivityFactor || signalDiff > 15 * sensitivityFactor) {
                leakType = "âš ï¸ ä¸­ç­‰æ¼æ°´";
                description = "æ£€æµ‹åˆ°æ˜æ˜¾æ¼æ°´ä¿¡å·";
                confidence = Math.min(85, 60 + Math.min(25, signalDiff / 2));
                leakIndicator.className = "leak-indicator leak-medium";
                leakIndicator.innerHTML = '<span class="leak-icon">âš ï¸</span><span class="leak-text">ä¸­ç­‰æ¼æ°´</span>';
                createLeakAnimation();
            } else if (signalRatio > 1.8 * sensitivityFactor || signalDiff > 8 * sensitivityFactor) {
                leakType = "ğŸ’§ è½»å¾®æ¼æ°´";
                description = "æ£€æµ‹åˆ°å¾®å¼±æ¼æ°´ä¿¡å·";
                confidence = Math.min(75, 50 + Math.min(25, signalDiff / 2));
                leakIndicator.className = "leak-indicator leak-low";
                leakIndicator.innerHTML = '<span class="leak-icon">ğŸ’§</span><span class="leak-text">è½»å¾®æ¼æ°´</span>';
                createLeakAnimation();
            } else {
                leakType = "âœ… æ— æ¼æ°´";
                description = "æœªæ£€æµ‹åˆ°æ¼æ°´ä¿¡å·";
                confidence = Math.max(70, 95 - Math.min(25, signalDiff));
                leakIndicator.className = "leak-indicator leak-none";
                leakIndicator.innerHTML = '<span class="leak-icon">âœ…</span><span class="leak-text">æ— æ¼æ°´</span>';
                // ç§»é™¤æ¼æ°´åŠ¨ç”»
                const oldAnimation = document.getElementById('leakAnimationContainer');
                if (oldAnimation) {
                    oldAnimation.remove();
                }
            }
            
            // æ–¹ä½åˆ¤æ–­é€»è¾‘ - åŸºäºæ¼æ°´ç‚¹åæ ‡
            const x = leakPosition.x;
            const y = leakPosition.y;
            const z = leakPosition.z;
            
            // åˆ¤æ–­æ¼æ°´ç‚¹ç›¸å¯¹äºçº¸æ¯å¬ç­’çš„ä½ç½®
            let direction = "";
            if (Math.abs(x) < 2 && Math.abs(z) < 2) {
                direction = "æ­£å¯¹çº¸æ¯å¬ç­’";
                confidence += 10;
            } else if (x > 0 && Math.abs(z) < 2) {
                direction = "çº¸æ¯å¬ç­’å³ä¾§";
            } else if (x < 0 && Math.abs(z) < 2) {
                direction = "çº¸æ¯å¬ç­’å·¦ä¾§";
            } else if (z > 0 && Math.abs(x) < 2) {
                direction = "çº¸æ¯å¬ç­’åæ–¹";
            } else if (z < 0 && Math.abs(x) < 2) {
                direction = "çº¸æ¯å¬ç­’å‰æ–¹";
            } else if (x > 0 && z > 0) {
                direction = "çº¸æ¯å¬ç­’å³åæ–¹";
            } else if (x > 0 && z < 0) {
                direction = "çº¸æ¯å¬ç­’å³å‰æ–¹";
            } else if (x < 0 && z > 0) {
                direction = "çº¸æ¯å¬ç­’å·¦åæ–¹";
            } else if (x < 0 && z < 0) {
                direction = "çº¸æ¯å¬ç­’å·¦å‰æ–¹";
            }
            
            // é«˜åº¦åˆ¤æ–­
            let heightInfo = "";
            if (y > 5) {
                heightInfo = "ä¸Šæ–¹";
            } else if (y < -5) {
                heightInfo = "ä¸‹æ–¹";
            } else {
                heightInfo = "æ°´å¹³æ–¹å‘";
                confidence += 5;
            }
            
            locationText = `æ¼æ°´ç‚¹ä½äº${direction}${heightInfo}`;
            
            // æ›´æ–°åˆ†ææŠ¥å‘Š
            signalAnalysis.textContent = `ğŸ“ˆ ä¿¡å·åˆ†æ: ${description} (ä¿¡å·å¼ºåº¦: ${avgSignal.toFixed(1)}, èƒŒæ™¯å™ªéŸ³å€æ•°: ${signalRatio.toFixed(2)})`;
            locationAnalysis.textContent = `ğŸ“ ä½ç½®åˆ†æ: ${locationText}`;
            confidenceValue.textContent = `${Math.round(confidence)}%`;
            confidenceBar.style.width = `${Math.round(confidence)}%`;
            locationResult.textContent = locationText;
            
            // æ›´æ–°æ¼æ°´ç‚¹åæ ‡æ˜¾ç¤º
            leakCoordX.textContent = x.toFixed(2);
            leakCoordY.textContent = y.toFixed(2);
            leakCoordZ.textContent = z.toFixed(2);
            const dist = Math.sqrt(x*x + y*y + z*z);
            leakDistance.textContent = dist.toFixed(2);
            
            // çŠ¶æ€æ›´æ–°
            if (leakType === "ğŸ’¥ ä¸¥é‡æ¼æ°´" || leakType === "âš ï¸ ä¸­ç­‰æ¼æ°´") {
                statusEl.style.background = "#f8d7da";
            } else if (leakType === "ğŸ’§ è½»å¾®æ¼æ°´") {
                statusEl.style.background = "#fff3cd";
            } else {
                statusEl.style.background = "#d4edda";
            }
        }

        // åœæ­¢ç³»ç»Ÿ
        function stopSystem() {
            isMonitoring = false;
            isDetecting = false;
            
            startBtn.disabled = false;
            calibrateBtn.disabled = true;
            detectBtn.disabled = true;
            stopBtn.disabled = true;
            
            startBtn.classList.remove('active');
            calibrateBtn.classList.remove('active');
            detectBtn.classList.remove('active');
            progressBar.style.display = 'none';
            
            statusEl.innerHTML = '<span class="status-icon">ğŸ›‘</span><span class="status-text">æ£€æµ‹å·²åœæ­¢</span>';
            statusEl.style.background = "#f8d9d9";
            detectionStatus.textContent = "å·²åœæ­¢";
        }

        // æ›´æ–°å‚æ•°
        updateParamsBtn.onclick = () => {
            bucketRadius = parseFloat(bucketRadiusInput.value);
            bucketHeight = parseFloat(bucketHeightInput.value);
            sensitivity = parseInt(sensitivityInput.value);
            
            // æ›´æ–°3Dåœºæ™¯
            createBucket();
            
            // å¦‚æœæœ‰æ¼æ°´ç‚¹ï¼Œç¡®ä¿å®ƒåœ¨æ–°çš„æ¡¶èŒƒå›´å†…
            if (leakPoint) {
                const currentX = leakPoint.position.x;
                const currentY = leakPoint.position.y;
                const currentZ = leakPoint.position.z;
                
                const newX = Math.max(-bucketRadius + 2, Math.min(bucketRadius - 2, currentX));
                const newY = Math.max(-bucketHeight/2 + 2, Math.min(bucketHeight/2 - 2, currentY));
                const newZ = Math.max(-bucketRadius + 2, Math.min(bucketRadius - 2, currentZ));
                
                createLeakPoint(newX, newY, newZ);
            }
            
            // æ›´æ–°ç²¾åº¦æŒ‡æ ‡
            accuracyRate.textContent = `${88 + sensitivity}%`;
            locationPrecision.textContent = `Â±${(2.5 - sensitivity * 0.15).toFixed(1)}cm`;
            responseTime.textContent = `${1.0 - sensitivity * 0.05}s`;
            
            // æ›´æ–°æ¼æ°´åŠ¨ç”»
            if (document.getElementById('leakAnimationContainer')) {
                createLeakAnimation();
            }
            
            statusEl.innerHTML = `<span class="status-icon">âœ…</span><span class="status-text">å‚æ•°å·²æ›´æ–°: æ¡¶åŠå¾„=${bucketRadius}cm, æ¡¶é«˜åº¦=${bucketHeight}cm, çµæ•åº¦=${sensitivity}</span>`;
            statusEl.style.background = "#d4edda";
        };

        // æ¼”ç¤ºæ¨¡å¼ - æ¨¡æ‹Ÿæ¼æ°´
        demoLeakBtn.onclick = () => {
            // è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            if (!isMonitoring) {
                startBtn.click();
                setTimeout(() => {
                    calibrateBtn.click();
                    setTimeout(() => {
                        // è®¾ç½®é«˜æ¼æ°´å¼ºåº¦
                        leakIntensity = 8;
                        
                        // æ‰§è¡Œæ£€æµ‹
                        detectBtn.click();
                    }, 5500);
                }, 1000);
            }
        };

        // æ¼”ç¤ºæ¨¡å¼ - æ¨¡æ‹Ÿæ— æ¼æ°´
        demoNoLeakBtn.onclick = () => {
            // è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            if (!isMonitoring) {
                startBtn.click();
                setTimeout(() => {
                    calibrateBtn.click();
                    setTimeout(() => {
                        // è®¾ç½®ä½æ¼æ°´å¼ºåº¦
                        leakIntensity = 2;
                        
                        // æ‰§è¡Œæ£€æµ‹
                        detectBtn.click();
                    }, 5500);
                }, 1000);
            }
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', function() {
            init3DScene();
            initCharts();
            
            // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
            sensitivityInput.addEventListener('input', function() {
                sensitivityValue.textContent = this.value;
            });
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            sensitivityValue.textContent = sensitivityInput.value;
        });
    </script>
</body>
</html>
